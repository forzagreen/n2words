name: CI

env:
  HUSKY: 0
  CI: true

on:
  push:
    branches:
      - main
      - v[0-9]
      - v[0-9][0-9]*
    tags:
      - v[0-9]*.[0-9]*.[0-9]*
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    name: Lint & Security
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Security audit
        run: npm audit --audit-level=high

      - name: Lint
        run: npm run lint

  test:
    name: Test (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        node: ['20', '22', '25']

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Validate languages
        run: |
          echo "::group::Language Validation"
          npm run lang:validate
          echo "::endgroup::"

      - name: Run unit tests
        run: |
          echo "::group::Unit Tests"
          npm run test:unit
          echo "::endgroup::"

      - name: Run integration tests
        run: |
          echo "::group::Integration Tests"
          npm run test:integration
          echo "::endgroup::"

      - name: Run type tests
        run: |
          echo "::group::Type Tests"
          npm run test:types
          echo "::endgroup::"

  test-web:
    name: Browser Tests
    if: ${{ github.event_name != 'push' || github.ref != 'refs/heads/main' }}
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run browser tests
        run: npm run test:web

      - name: Upload Playwright test results
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30
          if-no-files-found: ignore

  test-coverage:
    name: Test w/ Coverage (Node 24, Ubuntu)
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Run all tests with coverage
        run: npm run coverage

      - name: Check coverage thresholds
        run: npx c8 check-coverage --lines 90 --functions 90 --branches 85 --statements 90

      - name: Generate job summary
        id: summary
        continue-on-error: true
        run: |
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage/coverage-summary.json ] && command -v jq &> /dev/null; then
            TOTAL=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)

            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Lines** | ${TOTAL}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ Coverage data not available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-error: false

      - name: Upload coverage artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
          if-no-files-found: ignore

  verify:
    name: Verify Package
    runs-on: ubuntu-latest
    needs: [test, test-web, test-coverage]
    if: |
      !cancelled() &&
      needs.test.result == 'success' &&
      needs.test-coverage.result == 'success' &&
      (needs.test-web.result == 'success' || needs.test-web.result == 'skipped')
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Verify package contents
        run: npm pack --dry-run
