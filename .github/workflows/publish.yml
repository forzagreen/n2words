name: Publish

env:
  HUSKY: 0
  CI: true

on:
  push:
    tags:
      - v*

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  # Wait for CI to pass before publishing
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
    outputs:
      ci-success: ${{ steps.check.outputs.success }}

    steps:
      - name: Wait for CI workflow
        uses: actions/github-script@v8.0.0
        id: check
        with:
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            console.log(`Checking CI status for tag: ${tagName}`);

            // Get the ref object for this tag
            const { data: tagRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${tagName}`
            });

            // `tagRef.object` can be either the commit (lightweight tag)
            // or a tag object (annotated tag). If it's an annotated tag
            // the `object.sha` refers to the tag object, so we must
            // resolve it to the underlying commit SHA.
            let commitSha = tagRef.object.sha;
            console.log(`Tag object type: ${tagRef.object.type}`);

            if (tagRef.object.type === 'tag') {
              const { data: annotatedTag } = await github.rest.git.getTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                // NOTE: `tag_sha` expects the SHA of the tag *object* (for annotated tags),
                // not the commit SHA. Here `tagRef.object.sha` is that tag object SHA.
                tag_sha: tagRef.object.sha
              });
              commitSha = annotatedTag.object.sha;
              console.log(`Resolved annotated tag to commit SHA: ${commitSha}`);
            } else {
              console.log(`Lightweight tag points directly to commit SHA: ${commitSha}`);
            }

            // Wait for CI workflow to complete (max 30 min)
            const maxAttempts = 60;
            const delayMs = 30000; // 30 seconds

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              console.log(`Attempt ${attempt}/${maxAttempts}: Checking CI status...`);

              const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'ci.yml',
                head_sha: commitSha,
                per_page: 1
              });

              if (runs.total_count > 0) {
                const run = runs.workflow_runs[0];
                console.log(`CI workflow status: ${run.status}, conclusion: ${run.conclusion}`);

                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('‚úÖ CI passed! Proceeding with publish.');
                    core.setOutput('success', 'true');
                    return;
                  } else {
                    core.setFailed(`‚ùå CI failed with conclusion: ${run.conclusion}`);
                    return;
                  }
                }
              }

              if (attempt < maxAttempts) {
                console.log(`Waiting ${delayMs/1000}s before next check...`);
                await new Promise(resolve => setTimeout(resolve, delayMs));
              }
            }

            core.setFailed('‚è±Ô∏è Timeout: CI workflow did not complete within 30 minutes');

  publish:
    name: Publish to npm
    needs: check-ci
    if: needs.check-ci.outputs.ci-success == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v6.0.1
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Validate version matches tag
        id: version
        run: |
          PKG_VERSION="v$(node -p "require('./package.json').version")"
          TAG_VERSION="${GITHUB_REF#refs/tags/}"
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "‚ùå Error: package.json version ($PKG_VERSION) does not match tag ($TAG_VERSION)"
            exit 1
          fi
          echo "‚úÖ Version validated: $PKG_VERSION"
          echo "version=$PKG_VERSION" >> $GITHUB_OUTPUT

      - name: Verify git tag signature
        run: |
          if git tag -v "${GITHUB_REF#refs/tags/}" 2>/dev/null; then
            echo "‚úÖ Tag is signed"
          else
            echo "‚ö†Ô∏è Warning: Tag is not signed (consider signing release tags)"
          fi
        continue-on-error: true

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Security audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Build type declarations
        run: npm run build:types

      - name: Build web bundles
        run: npm run build

      - name: Verify build artifacts
        run: |
          echo "üì¶ Checking build artifacts..."
          ls -lh dist/
          echo ""
          echo "üìã Type declarations:"
          find lib -name "*.d.ts" -type f

      - name: Dry-run publish
        run: npm publish --dry-run

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6.0.0
        with:
          name: dist-${{ github.ref_name }}
          path: |
            dist/
            lib/**/*.d.ts
          retention-days: 90

      - name: Publish to npm with provenance
        id: publish
        run: |
          echo "üì§ Publishing to npm..."
          npm publish --provenance --access public
          echo "published=true" >> $GITHUB_OUTPUT
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify npm publication
        if: steps.publish.outputs.published == 'true'
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "üîç Verifying publication..."
          sleep 5  # Wait for npm registry to update
          npm view "$PKG_NAME@$PKG_VERSION" version || echo "‚ö†Ô∏è Package not yet available (may take a few minutes)"

      - name: Create GitHub Release
        id: release
        uses: softprops/action-gh-release@v2.5.0
        with:
          generate_release_notes: true
          files: |
            dist/*.js
            dist/*.js.map
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate job summary
        if: always()
        run: |
          echo "## üì¶ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${GITHUB_REF#refs/tags/}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Published** | ${{ steps.publish.outputs.published == 'true' && '‚úÖ Yes' || '‚ùå No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release** | ${{ steps.release.outputs.url || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.publish.outputs.published }}" == "true" ]; then
            PKG_NAME=$(node -p "require('./package.json').name")
            echo "### üìã Package Links" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **npm**: https://www.npmjs.com/package/$PKG_NAME/v/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **unpkg**: https://unpkg.com/$PKG_NAME@${{ steps.version.outputs.version }}/" >> $GITHUB_STEP_SUMMARY
            echo "- **jsDelivr**: https://cdn.jsdelivr.net/npm/$PKG_NAME@${{ steps.version.outputs.version }}/" >> $GITHUB_STEP_SUMMARY
          fi
